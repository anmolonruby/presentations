<!DOCTYPE html>
<head>
<meta charset="utf-8">
<style>

body {
  font-family: "Bree Serif", Helvetica, Arial, sans-serif;
  margin: 0;
  position: relative;
}

path.graticule { stroke:#555; fill:none; }

circle.on { fill:red; }

</style>
<script src="d3.v3.min.js"></script>
<script src="topojson.js"></script>
<script src="world.js"></script>
</head>
<body>
<script>
var width = 1920,
    height = 1080;

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
  .append("g")
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

svg.append('rect')
    .attr('width', width)
    .attr("height", height)
    .attr("transform", "translate(" + [-width / 2, -height / 2] + ")")
    .style('fill', '#eee');

var slide = svg.append('g');

function dumbstack(d) {
    var t = 0;
    d.forEach(function(_) {
        _.y = t;
        _.size = _.size || 120;
        t += _.size + 10;
    });
    return d;
}

function big(selection) {
    var lines = selection.selectAll('text.line')
        .data(function(d) { return d; }, function(d, i) { return d.text + i; })

    lines.exit()
        .transition()
        .duration(1000)
        .attr('transform', function(d) {
            return 'translate(' + [0, (-height/2 - 50)] + ')';
        })
        .remove();

    var enter = lines.enter()
        .append('text')
        .attr('class', 'line')
        .attr('text-anchor', 'middle')
        .text(function(d) { return d.text; })
        .attr('transform', 'translate(' + [0, -height/2 - 30] + ')')
        .transition()
        .delay(function(d, i) { return i * 500; })
        .duration(1000)
        .attr('transform', function(d) {
            return 'translate(' + [0, d.y] + ')';
        });

    lines.style('font-size', function(d) { return d.size + 'px'; })
}

var slides = [
{
    run: function() {
        slide.datum(dumbstack([
            { text: 'building iD in d3' },
            { text: '@tmcw', size: 60 },
            { text: 'GothamJS  July 12, 2013', size: 60 }
        ])).call(big)
    }
},
{
    run: function() {
        slide.datum(dumbstack([
            { text: 'building big things in d3' },
            { text: '@tmcw', size: 40 }
        ])).call(big)
    }
},
{
    run: function() {
        svg.selectAll('.slide-3').transition()
            .duration(1000)
            .attr('transform', 'scale(0,0)')
            .remove();
        slide.datum(dumbstack([
            { text: 'a new editor for openstreetmap' }
        ])).call(big)
    }
},
{
    run: function() {
        slide.datum(dumbstack([])).call(big)

        var projection = d3.geo.orthographic()
            .scale(10)
            .translate([0,0])
            .clipAngle(90);
            scale_lim = 500,
            graticule = d3.geo.graticule(),
            path = d3.geo.path().projection(projection);

        svg.append("path")
            .datum(topojson.feature(worldtopo, worldtopo.objects.land))
            .attr("class", "land slide-3")
            .attr("d", path);

        svg.append("path")
            .datum(graticule)
            .attr("class", "graticule slide-3");

        function run() {
            projection.rotate([projection.rotate()[0] + 1, projection.rotate()[1] + 0.1]);
            if (projection.scale() < scale_lim) projection.scale(projection.scale() + 10);
            svg.selectAll("path.land").attr("d", path);
            svg.selectAll("path.graticule").attr("d", path);
            if (current !== 3) return true;
            return false;
        }

        d3.timer(run);
    }
},
{
    run: function() {
        svg.selectAll('.slide-3,.slide-4').transition()
            .duration(1000)
            .attr('transform', 'scale(0,0)')
            .remove();
    }
},
{
    run: function() {
        var vid = svg.insert('foreignObject', ':first-child')
            .attr('class', 'slide-4')
            .append('xhtml:video')
            .style('position', 'absolute')
            .style('top', '100px')
            .attr('width', 1920)
            .attr('height', 1080)
            .attr('src', 'the_centers_of_all_openstreetmap_edits_640x320.mp4')

        vid.node().play();
    }
},
{
    run: function() {
        svg.selectAll('.slide-4').remove();
    }
},
];

var current = 0;
var slideCircles = svg.selectAll('circle.slide')
    .data(slides)
    .enter()
    .append('circle')
    .attr('transform', function(d, i) {
        return 'translate(' + [(-width / 2) + ((i + 1) * 50), ((-height / 2) + 40)] + ')';
    })
    .attr('r', 20)
    .on('click', function(d, i) {
        d.run();
        current = i;
        slideCircles.classed('on', function() { return this == d3.event.target; })
    });
</script>
</body>
